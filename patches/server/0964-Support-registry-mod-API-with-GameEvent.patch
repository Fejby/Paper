From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Sat, 25 Feb 2023 21:25:08 -0800
Subject: [PATCH] Support registry mod API with GameEvent


diff --git a/src/main/java/io/papermc/paper/registry/PaperRegistries.java b/src/main/java/io/papermc/paper/registry/PaperRegistries.java
index be562b04c626c2fe8c792f445cbdd73a0bb5327f..198acd382c3059e040fc3cc8fd3f8748ab0efed4 100644
--- a/src/main/java/io/papermc/paper/registry/PaperRegistries.java
+++ b/src/main/java/io/papermc/paper/registry/PaperRegistries.java
@@ -2,6 +2,7 @@ package io.papermc.paper.registry;
 
 import com.google.common.collect.ImmutableList;
 import io.papermc.paper.registry.entry.RegistryEntry;
+import io.papermc.paper.world.PaperGameEvent;
 import io.papermc.paper.world.structure.ConfiguredStructure;
 import io.papermc.paper.world.structure.PaperConfiguredStructure;
 import java.util.IdentityHashMap;
@@ -20,6 +21,7 @@ import org.checkerframework.checker.nullness.qual.Nullable;
 
 import static io.papermc.paper.registry.entry.RegistryEntry.immutable;
 import static io.papermc.paper.registry.entry.RegistryEntry.immutableBuiltIn;
+import static io.papermc.paper.registry.entry.RegistryEntry.writableBuiltIn;
 
 public final class PaperRegistries {
 
@@ -32,6 +34,7 @@ public final class PaperRegistries {
     static {
         REGISTRY_ENTRIES = ImmutableList.<RegistryEntry<?, ?>>builder()
             // built-ins
+            .add(writableBuiltIn(RegistryKey.GAME_EVENT, Registries.GAME_EVENT, PaperGameEvent::new, io.papermc.paper.world.PaperGameEvent.Builder::new))
             .add(immutableBuiltIn(RegistryKey.STRUCTURE_TYPE, Registries.STRUCTURE_TYPE, CraftStructureType::new))
 
             // data-drivens
diff --git a/src/main/java/io/papermc/paper/world/PaperGameEvent.java b/src/main/java/io/papermc/paper/world/PaperGameEvent.java
new file mode 100644
index 0000000000000000000000000000000000000000..0995cd6008486c784072a21f1990c935a801f5bb
--- /dev/null
+++ b/src/main/java/io/papermc/paper/world/PaperGameEvent.java
@@ -0,0 +1,59 @@
+package io.papermc.paper.world;
+
+import io.papermc.paper.registry.PaperRegistryBuilder;
+import org.bukkit.GameEvent;
+import org.bukkit.NamespacedKey;
+import org.checkerframework.checker.nullness.qual.NonNull;
+import org.checkerframework.checker.nullness.qual.Nullable;
+import org.checkerframework.framework.qual.DefaultQualifier;
+
+@DefaultQualifier(NonNull.class)
+public final class PaperGameEvent extends GameEvent {
+
+    private final net.minecraft.world.level.gameevent.GameEvent nms;
+
+    public PaperGameEvent(final NamespacedKey key, final net.minecraft.world.level.gameevent.GameEvent nms) {
+        super(key);
+        this.nms = nms;
+    }
+
+    @Override
+    public int getRange() {
+        return this.nms.getNotificationRadius();
+    }
+
+    public static final class Builder implements GameEvent.Builder, PaperRegistryBuilder<net.minecraft.world.level.gameevent.GameEvent, GameEvent> {
+
+        private final NamespacedKey key;
+        private int range = 16;
+
+        public Builder(NamespacedKey key, net.minecraft.world.level.gameevent.@Nullable GameEvent nms) {
+            this.key = key;
+            if (nms != null) {
+                this.range = nms.getNotificationRadius();
+            }
+        }
+
+        @Override
+        public NamespacedKey getKey() {
+            return this.key;
+        }
+
+        @Override
+        public int range() {
+            return this.range;
+        }
+
+        @Override
+        public Builder range(int range) {
+            this.range = range;
+            return this;
+        }
+
+        @Override
+        public net.minecraft.world.level.gameevent.GameEvent build() {
+            return new net.minecraft.world.level.gameevent.GameEvent(this.key.value(), this.range);
+        }
+    }
+
+}
diff --git a/src/main/java/net/minecraft/world/level/gameevent/GameEvent.java b/src/main/java/net/minecraft/world/level/gameevent/GameEvent.java
index 0cb8464145995aea393f1d2c0d065fb3fc6ac635..7a0168ce52e60ca713663620131378a0cbcdaff2 100644
--- a/src/main/java/net/minecraft/world/level/gameevent/GameEvent.java
+++ b/src/main/java/net/minecraft/world/level/gameevent/GameEvent.java
@@ -79,7 +79,7 @@ public class GameEvent {
     }
 
     private static GameEvent register(String id, int range) {
-        return Registry.register(BuiltInRegistries.GAME_EVENT, id, new GameEvent(id, range));
+        return io.papermc.paper.registry.PaperRegistryListenerManager.INSTANCE.registerWithListeners(BuiltInRegistries.GAME_EVENT, id, new GameEvent(id, range)); // Paper
     }
 
     @Override
diff --git a/src/main/java/org/bukkit/craftbukkit/util/Commodore.java b/src/main/java/org/bukkit/craftbukkit/util/Commodore.java
index ebbbfc318439fec33331d71563e528cd3429e541..394a406a2779c7b46ed24aebab6822e01c78d359 100644
--- a/src/main/java/org/bukkit/craftbukkit/util/Commodore.java
+++ b/src/main/java/org/bukkit/craftbukkit/util/Commodore.java
@@ -260,6 +260,15 @@ public class Commodore
                             }
                         }
                         // Paper end - DisplaySlot
+                        // Paper start - change GameEvent to Reference
+                        if ( owner.equals( "org/bukkit/GameEvent" ) && desc.equals("Lorg/bukkit/GameEvent;" ) )
+                        {
+                            super.visitFieldInsn( opcode, owner, name, "Lio/papermc/paper/registry/Reference;" );
+                            super.visitMethodInsn( Opcodes.INVOKEINTERFACE, "io/papermc/paper/registry/Reference", "value", "()Lorg/bukkit/Keyed;", true );
+                            super.visitTypeInsn( Opcodes.CHECKCAST, "org/bukkit/GameEvent" );
+                            return;
+                        }
+                        // Paper end
 
                         if ( owner.equals( "org/bukkit/block/Biome" ) )
                         {
